# Интеллектуальный Оптимизатор Заказов

## Обзор

Интеллектуальный оптимизатор заказов - это продвинутая система для прогнозирования будущих потребностей и динамического формирования заказов с использованием машинного обучения и анализа сезонности.

## Основные возможности

### 🧠 ML-прогнозирование
- **Интеграция с ML-сервисом** для получения точных прогнозов спроса
- **Анализ трендов** (растущий, падающий, стабильный)
- **Сезонный анализ** с учетом времени года
- **Уровни уверенности** прогнозов

### 📊 Динамическое формирование заказов
- **Приоритизация по критичности** - товары с угрозой OoS получают приоритет
- **Учет ML-прогнозов** при расчете необходимого объема
- **Оптимизация до минимального заказа** с максимальным покрытием
- **Применение кратности** заказов согласно правилам товаров

### 🚚 Оптимизация доставки
- **Анализ возможности объединения** доставки линз и растворов
- **Расчет экономии** на доставке
- **Рекомендации по датам** поставки

### 💡 ML-инсайты
- **Анализ трендов** по всем товарам
- **Влияние сезонности** на спрос
- **Уровни уверенности** прогнозов
- **Рекомендации** для улучшения закупок

## Архитектура

### Компоненты системы

```
┌─────────────────────────────────────────────────────────────┐
│                    API Gateway                              │
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────────┐
│              Intelligent Order Optimizer                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   ML Service    │  │ Product Rules   │  │  Optimizer  │ │
│  │  Integration    │  │                 │  │   Logic     │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────────────┐
│                    ML Service                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │ Linear Model    │  │ Random Forest   │  │   SARIMA    │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### Ключевые файлы

- `intelligent_order_optimizer.py` - Основная логика оптимизатора
- `ml_integration.py` - Интеграция с ML-сервисом
- `product_rules.py` - Правила для разных типов товаров
- `api_intelligent_optimizer.py` - API endpoints

## Использование

### Базовое использование

```python
from intelligent_order_optimizer import IntelligentOrderOptimizer

# Создаем оптимизатор
optimizer = IntelligentOrderOptimizer()

# Данные для анализа
sku_data = [
    {'code': '30001', 'stock': 385, 'consumption': 1, 'diopter': -0.5},
    {'code': '30002', 'stock': 154, 'consumption': 1, 'diopter': -0.75},
    # ...
]

# Исторические данные для ML
historical_data = {
    '30001': [1.2, 1.1, 1.3, 1.0, 1.2, 1.4, 1.1, 1.3, 1.2, 1.1],
    '30002': [0.8, 0.9, 1.0, 0.8, 0.9, 1.1, 0.8, 0.9, 1.0, 0.8],
    # ...
}

# Выполняем оптимизацию
result = await optimizer.analyze_intelligent_order(sku_data, historical_data)
```

### API использование

```bash
# POST запрос к API
curl -X POST "http://localhost:8000/optimize" \
  -H "Content-Type: application/json" \
  -d '{
    "sku_data": [
      {"code": "30001", "stock": 385, "consumption": 1, "diopter": -0.5}
    ],
    "historical_data": [
      {
        "product_code": "30001",
        "consumption_history": [1.2, 1.1, 1.3, 1.0, 1.2]
      }
    ],
    "ml_forecasting": true,
    "delivery_optimization": true
  }'
```

## Алгоритм работы

### 1. Анализ данных
- Загрузка ML-моделей
- Получение исторических данных
- Анализ каждого SKU с ML-прогнозированием

### 2. ML-прогнозирование
- Получение прогнозов от ML-сервиса
- Анализ трендов и сезонности
- Расчет уровней уверенности

### 3. Приоритизация
- Сортировка по приоритету (угроза OoS + ML-прогноз)
- Учет критичности товаров
- Анализ оптимизации доставки

### 4. Формирование заказа
- Динамическое формирование до минимального объема
- Применение кратности заказов
- Расчет покрытия и новых дат OoS

### 5. Генерация инсайтов
- Анализ трендов по всем товарам
- Влияние сезонности
- Рекомендации для улучшения

## ML-модели

### Поддерживаемые модели
- **Linear Regression** - для стабильных товаров
- **Random Forest** - для сложных паттернов
- **SARIMA** - для временных рядов с сезонностью
- **Ensemble** - комбинация моделей

### Особенности прогнозирования
- **Адаптивное обучение** на новых данных
- **Анализ сезонности** по месяцам
- **Учет трендов** (растущий/падающий/стабильный)
- **Уровни уверенности** прогнозов

## Правила товаров

### Типы товаров
- **Однодневные линзы** (код 30хххх) - мин. заказ 3000, кратность 30
- **Месячные линзы** (код 6хххх, 3хххх) - мин. заказ 5000, кратность 50
- **Растворы** (код 360360, 500500, 120120) - мин. заказ 5000, кратность 24/48

### Сроки поставки
- **Линзы**: 45 дней производство + 12 дней доставка
- **Растворы**: 45 дней производство + 37 дней доставка
- **Объединенная доставка**: экономия до 12 дней

## API Endpoints

### POST /optimize
Интеллектуальная оптимизация заказа

**Параметры:**
- `sku_data` - данные SKU для анализа
- `historical_data` - исторические данные для ML
- `ml_forecasting` - включить ML-прогнозирование
- `delivery_optimization` - включить оптимизацию доставки

**Ответ:**
```json
{
  "order_needed": true,
  "total_volume": 5000,
  "min_order": 5000,
  "utilization": 100.0,
  "sku_orders": [...],
  "delivery_optimization": {...},
  "ml_insights": {...},
  "processing_time": 1.23
}
```

### GET /health
Проверка здоровья сервиса

### GET /ml-status
Статус ML-сервиса

### POST /batch-optimize
Batch оптимизация заказов

### GET /optimizer/features
Информация о возможностях оптимизатора

## Тестирование

### Запуск тестов
```bash
python test_intelligent_optimizer.py
```

### Тестовые данные
- 5 SKU с разными уровнями остатков
- Исторические данные для ML-прогнозирования
- Проверка всех функций оптимизатора

## Мониторинг

### Метрики
- **Время обработки** запросов
- **Точность прогнозов** ML-моделей
- **Использование минимального заказа**
- **Экономия на доставке**

### Логирование
- Детальные логи всех операций
- Ошибки и предупреждения
- Производительность ML-моделей

## Развертывание

### Docker
```bash
# Сборка образа
docker build -t intelligent-optimizer .

# Запуск контейнера
docker run -p 8000:8000 intelligent-optimizer
```

### Требования
- Python 3.8+
- FastAPI
- aiohttp
- numpy
- pandas

## Будущие улучшения

### Планируемые функции
- **Интеграция с внешними данными** (погода, события)
- **Адаптивное обучение** на новых данных
- **A/B тестирование** разных стратегий
- **Интеграция с системой уведомлений**
- **Веб-интерфейс** для мониторинга

### Оптимизации
- **Кэширование** ML-прогнозов
- **Параллельная обработка** batch запросов
- **Оптимизация памяти** для больших объемов данных
- **Улучшение точности** ML-моделей

## Поддержка

### Логи
- Все операции логируются с деталями
- Ошибки содержат stack trace
- Производительность отслеживается

### Отладка
- Тестовый endpoint `/optimizer/test`
- Детальные результаты в JSON
- Возможность отключения ML для тестирования

### Контакты
- Документация: `INTELLIGENT_OPTIMIZER_DOCUMENTATION.md`
- Тесты: `test_intelligent_optimizer.py`
- API: Swagger UI на `/docs` 