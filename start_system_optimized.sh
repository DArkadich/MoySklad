#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∑–∞–∫—É–ø–æ–∫..."
echo "üìä –í–µ—Ä—Å–∏—è: 2.0 (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –ú–æ–π–°–∫–ª–∞–¥
if [ -z "$MOYSKLAD_API_TOKEN" ]; then
    echo "‚ùå MOYSKLAD_API_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω: export MOYSKLAD_API_TOKEN='–≤–∞—à_—Ç–æ–∫–µ–Ω'"
    exit 1
else
    echo "‚úÖ –¢–æ–∫–µ–Ω –ú–æ–π–°–∫–ª–∞–¥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose down

# –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã
echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã..."
docker-compose up -d

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker-compose ps

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ API..."
sleep 5

# –¢–µ—Å—Ç API
if command -v curl &> /dev/null; then
    API_RESPONSE=$(curl -s http://localhost:8001/health 2>/dev/null)
    if [ $? -eq 0 ]; then
        echo "‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω"
    else
        echo "‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    fi
else
    echo "‚ö†Ô∏è  curl –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É API"
fi

echo ""
echo "üéâ –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞!"
echo ""
echo "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:"
echo "  ‚Ä¢ API –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è: http://localhost:8001"
echo "  ‚Ä¢ RabbitMQ Management: http://localhost:15672"
echo "  ‚Ä¢ PostgreSQL: localhost:5432"
echo "  ‚Ä¢ Redis: localhost:6379"
echo ""
echo "üìù –õ–æ–≥–∏:"
echo "  ‚Ä¢ docker-compose logs forecast-api"
echo "  ‚Ä¢ docker-compose logs automation-cron"
echo ""
echo "üîÑ –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ 6:00"
echo "üìä –û—Ç—á–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–∞–ø–∫—É ./data/"
echo ""
echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API:"
echo "  ‚Ä¢ python3 test_api_simple.py" 