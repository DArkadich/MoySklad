# Миграция на реальные данные из MoySklad

## Проблема

Текущая система использует синтетические данные для товара с кодом `30001`, которого не существует в реальной системе MoySklad. Нужно перейти на использование реальных данных из API MoySklad.

## Решение

### 1. Подготовка

Убедитесь, что у вас настроены переменные окружения:

```bash
# .env файл
MOYSKLAD_API_TOKEN=your_api_token_here
MOYSKLAD_API_URL=https://api.moysklad.ru/api/remap/1.2
```

### 2. Обучение моделей на реальных данных

Запустите скрипт для получения реальных данных и обучения моделей:

```bash
python train_real_models.py
```

Этот скрипт:
- Получает список всех товаров из MoySklad
- Собирает данные о продажах за последние 180 дней
- Собирает данные об остатках за последние 30 дней
- Обучает модели для каждого товара с достаточным количеством данных
- Сохраняет модели в директории `data/real_models/`

### 3. Обновление API

Запустите скрипт для обновления API сервиса:

```bash
python update_api_for_real_models.py
```

Этот скрипт:
- Обновляет `services/moysklad-service/app/api_ml.py`
- Добавляет функцию загрузки реальных моделей
- Обновляет логику прогнозирования для использования реальных товаров
- Создает скрипт тестирования `test_real_models.py`

### 4. Перезапуск сервисов

После обучения моделей и обновления API перезапустите сервисы:

```bash
# Остановка сервисов
./stop_system.sh

# Запуск с обновленным API
./start_system.sh
```

### 5. Тестирование

Запустите тестирование реальных моделей:

```bash
python test_real_models.py
```

## Структура реальных моделей

После обучения модели сохраняются в следующей структуре:

```
data/real_models/
├── {product_id}_linear_regression.pkl
├── {product_id}_linear_regression_scaler.pkl
├── {product_id}_random_forest.pkl
├── {product_id}_random_forest_scaler.pkl
└── {product_id}_metadata.json
```

## API изменения

### Старый API (синтетические данные)
```json
{
  "product_code": "30001",
  "forecast_days": 30
}
```

### Новый API (реальные данные)
```json
{
  "product_code": "real_product_id_from_moysklad",
  "forecast_days": 30
}
```

## Проверка работы

### 1. Проверка загрузки реальных моделей

```bash
curl -s http://localhost:8001/models/status | jq '.'
```

Ожидаемый ответ:
```json
{
  "total_models": 5,
  "model_codes": ["real_product_id_1", "real_product_id_2", ...],
  "last_updated": "2025-08-03T20:00:00.000000"
}
```

### 2. Тестирование прогноза для реального товара

```bash
curl -X POST http://localhost:8001/forecast \
  -H "Content-Type: application/json" \
  -d '{"product_code":"real_product_id","forecast_days":30}'
```

### 3. Проверка логов

```bash
docker-compose logs forecast-api | grep "реальные модели"
```

## Устранение неполадок

### Проблема: Нет данных для товаров
**Решение**: Проверьте, что в MoySklad есть товары с историей продаж за последние 180 дней.

### Проблема: Ошибка API MoySklad
**Решение**: Проверьте правильность API токена и его права доступа.

### Проблема: Модели не загружаются
**Решение**: Проверьте, что директория `data/real_models/` существует и содержит файлы моделей.

### Проблема: Fallback на синтетические данные
**Решение**: Убедитесь, что реальные модели обучены и API обновлен.

## Мониторинг

### Логи загрузки моделей
```bash
docker-compose logs forecast-api | grep "Загружены реальные модели"
```

### Статистика использования моделей
```bash
docker-compose logs forecast-api | grep "Использованы реальные модели"
```

## Откат к синтетическим данным

В случае проблем можно временно вернуться к синтетическим данным:

1. Переименуйте директорию `data/real_models/` в `data/real_models_backup/`
2. Перезапустите сервисы
3. Система автоматически использует универсальную модель

## Дальнейшие улучшения

1. **Автоматическое переобучение**: Настройте периодическое переобучение моделей на новых данных
2. **Мониторинг качества**: Добавьте метрики качества прогнозов
3. **Кэширование**: Оптимизируйте запросы к API MoySklad
4. **Масштабирование**: Добавьте поддержку большего количества товаров

## Контакты

При возникновении проблем обращайтесь к документации или создавайте issue в репозитории. 