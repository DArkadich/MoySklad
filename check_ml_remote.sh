#!/bin/bash

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - –ò–ó–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –ê–î–†–ï–° –°–ï–†–í–ï–†–ê
PROD_SERVER="${1:-denis@localhost}"
PROD_PATH="~/MoySklad"

echo "üîç –£–î–ê–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê ML-–ú–û–î–ï–õ–ï–ô –ù–ê –ü–†–û–î–ê–ö–®–ù–ï"
echo "================================================"
echo "üìÖ –í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏: $(date)"
echo "üåê –°–µ—Ä–≤–µ—Ä: $PROD_SERVER"
echo "üìÅ –ü—É—Ç—å: $PROD_PATH"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "üìñ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:"
    echo "   $0 [—Å–µ—Ä–≤–µ—Ä]"
    echo ""
    echo "üìã –ü–†–ò–ú–ï–†–´:"
    echo "   $0 denis@192.168.1.100"
    echo "   $0 denis@prod-server.local"
    echo "   $0 denis@localhost"
    echo ""
    echo "üîß –ù–ê–°–¢–†–û–ô–ö–ê SSH:"
    echo "   1. –î–æ–±–∞–≤—å—Ç–µ –≤ ~/.ssh/config:"
    echo "      Host prod-server"
    echo "          HostName 192.168.1.100"
    echo "          User denis"
    echo "          IdentityFile ~/.ssh/id_ed25519"
    echo "   2. –ó–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: $0 denis@prod-server"
    echo ""
    exit 0
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
echo "1Ô∏è‚É£ –ü–†–û–í–ï–†–ö–ê SSH –°–û–ï–î–ò–ù–ï–ù–ò–Ø"
echo "---------------------------"

if ssh -o ConnectTimeout=10 -o BatchMode=yes "$PROD_SERVER" "echo 'SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'" 2>/dev/null; then
    echo "‚úÖ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ"
    echo ""
    echo "üîß –†–ï–®–ï–ù–ò–ï:"
    echo "   1. –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞:"
    echo "      $0 denis@IP_–ê–î–†–ï–°_–°–ï–†–í–ï–†–ê"
    echo ""
    echo "   2. –ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ ~/.ssh/config:"
    echo "      Host prod-server"
    echo "          HostName IP_–ê–î–†–ï–°_–°–ï–†–í–ï–†–ê"
    echo "          User denis"
    echo "          IdentityFile ~/.ssh/id_ed25519"
    echo ""
    echo "   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞:"
    echo "      ping IP_–ê–î–†–ï–°_–°–ï–†–í–ï–†–ê"
    echo ""
    echo "üìñ –°–ø—Ä–∞–≤–∫–∞: $0 --help"
    exit 1
fi

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ ML –º–æ–¥–µ–ª–µ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω-—Å–µ—Ä–≤–µ—Ä–µ
echo ""
echo "2Ô∏è‚É£ –ó–ê–ü–£–°–ö –ü–†–û–í–ï–†–ö–ò ML –ú–û–î–ï–õ–ï–ô"
echo "-------------------------------"

echo "üöÄ –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω-—Å–µ—Ä–≤–µ—Ä–µ..."
ssh "$PROD_SERVER" "cd $PROD_PATH && ./check_production_ml.sh"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
else
    echo ""
    echo "‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"
fi

echo ""
echo "üìÖ –£–¥–∞–ª–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $(date)"
echo ""
echo "üí° –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ö–û–ú–ê–ù–î–´:"
echo "   ‚Ä¢ –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ssh $PROD_SERVER"
echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: ssh $PROD_SERVER 'cd $PROD_PATH && docker-compose logs'"
echo "   ‚Ä¢ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É: ssh $PROD_SERVER 'cd $PROD_PATH && ./restart_system_fixed.sh'"
